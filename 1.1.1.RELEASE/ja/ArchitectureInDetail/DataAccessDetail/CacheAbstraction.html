<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.2. キャッシュの抽象化（Cache Abstraction） &#8212; Macchinetta Framework オンライン版クラウド拡張 Development Guideline 1.1.1.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.1.1.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5. AWS連携" href="../../AWSCollaboration/index.html" />
    <link rel="prev" title="4.1. データベースシャーディング" href="DataAccessMyBatis3.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../AWSCollaboration/index.html" title="5. AWS連携"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="4.1. データベースシャーディング"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Framework オンライン版クラウド拡張 Development Guideline 1.1.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">4. データアクセス</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.2. キャッシュの抽象化（Cache Abstraction）</a><ul>
<li><a class="reference internal" href="#overview">4.2.1. Overview</a><ul>
<li><a class="reference internal" href="#cache-local-heap">4.2.1.1. ローカルヒープを使用したキャッシュ</a></li>
<li><a class="reference internal" href="#redis">4.2.1.2. Redisを使用したキャッシュ</a></li>
<li><a class="reference internal" href="#id3">4.2.1.3. キャッシュ方式の選択</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">4.2.2. How to use</a><ul>
<li><a class="reference internal" href="#cache-setting">4.2.2.1. Spring Cache Abstractionの設定</a><ul>
<li><a class="reference internal" href="#cache-local-heap-setting">4.2.2.1.1. ローカルヒープを使用したキャッシュの設定</a></li>
<li><a class="reference internal" href="#cache-redis-setting">4.2.2.1.2. Redisを使用したキャッシュの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-data-regist">4.2.2.2. キャッシュするデータの選択</a></li>
<li><a class="reference internal" href="#id8">4.2.2.3. キャッシュしたデータの削除</a></li>
<li><a class="reference internal" href="#id9">4.2.2.4. 注意事項</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend">4.2.3. How to extend</a><ul>
<li><a class="reference internal" href="#redis-setting-for-multi-instance">4.2.3.1. 目的別に接続先Redisを指定する</a></li>
<li><a class="reference internal" href="#muiti-cache-manager">4.2.3.2. 複数のキャッシュマネージャを併用する</a></li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="DataAccessMyBatis3.html"
                        title="previous chapter">4.1. データベースシャーディング</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../../AWSCollaboration/index.html"
                        title="next chapter">5. AWS連携</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/CacheAbstraction.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="cache-abstraction">
<h1>4.2. キャッシュの抽象化（Cache Abstraction）<a class="headerlink" href="#cache-abstraction" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id1">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id12">Overview</a><ul>
<li><a class="reference internal" href="#cache-local-heap" id="id13">ローカルヒープを使用したキャッシュ</a></li>
<li><a class="reference internal" href="#redis" id="id14">Redisを使用したキャッシュ</a></li>
<li><a class="reference internal" href="#id3" id="id15">キャッシュ方式の選択</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id16">How to use</a><ul>
<li><a class="reference internal" href="#cache-setting" id="id17">Spring Cache Abstractionの設定</a><ul>
<li><a class="reference internal" href="#cache-local-heap-setting" id="id18">ローカルヒープを使用したキャッシュの設定</a></li>
<li><a class="reference internal" href="#cache-redis-setting" id="id19">Redisを使用したキャッシュの設定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cache-data-regist" id="id20">キャッシュするデータの選択</a></li>
<li><a class="reference internal" href="#id8" id="id21">キャッシュしたデータの削除</a></li>
<li><a class="reference internal" href="#id9" id="id22">注意事項</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-extend" id="id23">How to extend</a><ul>
<li><a class="reference internal" href="#redis-setting-for-multi-instance" id="id24">目的別に接続先Redisを指定する</a></li>
<li><a class="reference internal" href="#muiti-cache-manager" id="id25">複数のキャッシュマネージャを併用する</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id12">4.2.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>本ガイドラインでは、<a class="reference internal" href="../../ImplementationAtEachLayer/PersistenceLayerScalability.html"><span class="doc">データ永続層のスケール性の確保</span></a> にて紹介しているキャッシュ方式の実現により、データアクセス処理の負荷低減および高速化する方法を紹介する。
キャッシュ方式の実現方法にはSpring Cache Abstractionを採用する。Spring Cache Abstractionによるキャッシュ実装の抽象化により、キャッシュ実装の置換を容易化したり、コーディング方法を統一化することによる習得コストの低減などが見込める。</p>
<p>セッションを外部管理化するためにキャッシュを利用する方法については、 <a class="reference internal" href="../../AWSCollaboration/SessionManagement.html"><span class="doc">セッション外部管理</span></a> を参照されたい。</p>
<p>Springのガイドについては、 <a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/integration.html#cache">Spring Cache Abstraction</a> を参照されたい。</p>
<div class="section" id="cache-local-heap">
<span id="id2"></span><h3><a class="toc-backref" href="#id13">4.2.1.1. ローカルヒープを使用したキャッシュ</a><a class="headerlink" href="#cache-local-heap" title="Permalink to this headline">¶</a></h3>
<p>以下で、キャッシュ実装にローカルヒープ領域を使用した場合の処理の流れを示す。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/cache-abstraction.png"><img alt="../../_images/cache-abstraction.png" src="../../_images/cache-abstraction.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">Controller</span></code>または<code class="docutils literal"><span class="pre">Service</span></code>は、引数を渡しキャッシュ定義されたDomain Layerの<code class="docutils literal"><span class="pre">Service</span></code>メソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">Cache AOPは、引数を元にキャッシュキーを特定し<code class="docutils literal"><span class="pre">SimpleCacheManager</span></code>を使用して<code class="docutils literal"><span class="pre">ConcurrentHashMap</span></code>から既に登録済のキャッシュデータを取得する。</p>
<p class="last">キャッシュデータが取得出来た場合は<code class="docutils literal"><span class="pre">Controller</span></code>または<code class="docutils literal"><span class="pre">Service</span></code>へキャッシュデータを返却し、キャッシュデータが取得出来ない場合は(3)および(4)を実行する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first">Cache AOPは、引数を渡しキャッシュ定義されたDomain Layerの<code class="docutils literal"><span class="pre">Service</span></code>メソッドを実行し戻り値を取得する。</p>
<p class="last">Cache AOPは、(2)で特定したキャッシュキーで、取得した戻り値を<code class="docutils literal"><span class="pre">SimpleCacheManager</span></code>を使用して<code class="docutils literal"><span class="pre">ConcurrentHashMap</span></code>へキャッシュデータとして格納する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Cache AOPは、<code class="docutils literal"><span class="pre">Controller</span></code>または<code class="docutils literal"><span class="pre">Service</span></code>へ取得した戻り値を返却する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="redis">
<span id="cache-redis"></span><h3><a class="toc-backref" href="#id14">4.2.1.2. Redisを使用したキャッシュ</a><a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h3>
<p>以下で、キャッシュ実装にRedisを使用した場合の処理の流れを示す。
キャッシュを行う仕組みはローカルヒープを使用したキャッシュと同一であるが、<code class="docutils literal"><span class="pre">CacheManager</span></code>として<code class="docutils literal"><span class="pre">RedisCacheManager</span></code>を使用する。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/cache-abstraction-redis.png"><img alt="../../_images/cache-abstraction-redis.png" src="../../_images/cache-abstraction-redis.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Cache AOPは、特定したキャッシュキーで、取得した戻り値を<code class="docutils literal"><span class="pre">RedisCacheManager</span></code>を使用してRedisへキャッシュデータとして格納する。また、ControllerまたはServiceへ取得した戻り値を返却する。
Redisへのアクセスは、Spring Data Redisを使用して行われる。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id15">4.2.1.3. キャッシュ方式の選択</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>本ガイドラインでは、ローカルヒープを使用したキャッシュとRedisを使用したキャッシュを紹介するが、各キャッシュ方式によって特徴が異なる。
そのため、アプリケーションの要件に応じて適したキャッシュ方式を選択されたい。</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="20%" />
<col width="40%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">キャッシュ方式</th>
<th class="head">特徴</th>
<th class="head">適したアプリケーション</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">ローカルヒープを使用したキャッシュ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">Redisを使用したキャッシュよりも高速であるが、APサーバインスタンスのローカルヒープにキャッシュを保持するため、サーバインスタンス間のキャッシュを同期することができない。また、キャッシュするデータ量に応じてサーバインスタンスのメモリ消費量が大きくなる。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">キャッシュ対象とするデータがマスタデータ等の運用中に更新されることが想定されないデータに限定されるアプリケーションなどに適している。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">Redisを使用したキャッシュ</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">キャッシュをRedisに保持するため、キャッシュデータを複数のサーバインスタンス間で同期することが可能である。また、キャッシュデータ量が大きくなってもサーバインスタンスのメモリ消費量が大きくなることはない。</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">キャッシュ対象とするデータ量が大きく、運用中の更新が見込まれるアプリケーションなどに適している。</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Spring Cache Abstractionを使用したキャッシュの実装では、複数のキャッシュ方式を併用することが可能である。
詳細は、<a class="reference internal" href="#muiti-cache-manager"><span class="std std-ref">複数のキャッシュマネージャを併用する</span></a> を参照されたい。</p>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id16">4.2.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>以下でSpring Cache Abstractionの利用にあたり、事前に必要な設定、およびアプリケーションでキャッシュデータへアクセスする方法を説明する。</p>
<div class="section" id="cache-setting">
<span id="id4"></span><h3><a class="toc-backref" href="#id17">4.2.2.1. Spring Cache Abstractionの設定</a><a class="headerlink" href="#cache-setting" title="Permalink to this headline">¶</a></h3>
<div class="section" id="cache-local-heap-setting">
<span id="id5"></span><h4><a class="toc-backref" href="#id18">4.2.2.1.1. ローカルヒープを使用したキャッシュの設定</a><a class="headerlink" href="#cache-local-heap-setting" title="Permalink to this headline">¶</a></h4>
<p>キャッシュの機能を有効にするには、キャッシュマネージャの設定が必要になる。
以下に、ローカルヒープを使用したキャッシュマネージャの設定例を示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span>・・・
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;cache:annotation-driven</span> <span class="na">order=</span><span class="s">&quot;-1&quot;</span> <span class="nt">/&gt;</span>
・・・
<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cacheManager&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.cache.support.SimpleCacheManager&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (3) --&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;caches&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;set&gt;</span>
            <span class="nt">&lt;bean</span>
                <span class="na">class=</span><span class="s">&quot;org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;members&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
            ・・・
        <span class="nt">&lt;/set&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">アノテーションでのキャッシュを有効にする。</p>
<p class="last">キャッシュデータの管理をするため<code class="docutils literal"><span class="pre">order=&quot;-1&quot;</span></code>を設定し、キャッシュインターセプタがトランザクションインターセプタより先に動作する設定とする。これにより、キャッシュデータの参照はトランザクション開始前に、登録と削除はトランザクションの終了後に行う。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>キャッシュデータの格納場所にローカルヒープ領域を使用する場合は、Springが提供する<code class="docutils literal"><span class="pre">SimpleCacheManager</span></code>をキャッシュマネージャとして使用する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">caches</span></code>プロパティに、実際にキャッシュデータを格納する「入れ物(Cache)」をBean定義する。<code class="docutils literal"><span class="pre">SimpleCacheManager</span></code>を使用する場合は、後述する<code class="docutils literal"><span class="pre">&#64;CacheConfig</span></code>アノテーションに対応した数だけBean定義が必要になる。「入れ物」の実装にJDK標準の<code class="docutils literal"><span class="pre">ConcurrentHashMap</span></code>を使用する場合は<code class="docutils literal"><span class="pre">ConcurrentMapCacheFactoryBean</span></code>を使用する。<code class="docutils literal"><span class="pre">&#64;CacheConfig</span></code>との関連付けのため、<code class="docutils literal"><span class="pre">name</span></code>プロパティには<code class="docutils literal"><span class="pre">&#64;CacheConfig</span></code>の<code class="docutils literal"><span class="pre">cacheNames</span></code>に指定するキャッシュ名を設定する</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">ローカルヒープ領域における「入れ物」の実装は、<code class="docutils literal"><span class="pre">ConcurrentMapCacheFactoryBean</span></code>以外のものもSpringに用意されている。
詳細は <a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/integration.html#cache-store-configuration">Springのリファレンス Configuring the cache storage</a> を参照されたい。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="cache-redis-setting">
<span id="id6"></span><h4><a class="toc-backref" href="#id19">4.2.2.1.2. Redisを使用したキャッシュの設定</a><a class="headerlink" href="#cache-redis-setting" title="Permalink to this headline">¶</a></h4>
<p>以下に、Redisを使用したキャッシュマネージャの設定例を示す。</p>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">pom.xml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- (1) --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.data<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- (2) --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">依存ライブラリに<code class="docutils literal"><span class="pre">spring-data-redis</span></code>を追加する。</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line">依存ライブラリに<code class="docutils literal"><span class="pre">jedis</span></code>を追加する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first"><code class="file docutils literal"><span class="pre">xxx-env.xml</span></code></p>
<div class="highlight-xml"><div class="highlight"><pre><span></span>・・・
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;cache:annotation-driven</span> <span class="na">order=</span><span class="s">&quot;-1&quot;</span> <span class="nt">/&gt;</span>
・・・
<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cacheManager&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.cache.RedisCacheManager&quot;</span>
    <span class="na">factory-method=</span><span class="s">&quot;create&quot;</span>
    <span class="na">c:connection-factory-ref=</span><span class="s">&quot;redisConnectionFactory&quot;</span>
    <span class="na">p:transaction-aware=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
・・・
<span class="c">&lt;!-- (3) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;redisConnectionFactory&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span>
    <span class="na">p:host-name=</span><span class="s">&quot;${spring.redis.host}&quot;</span> <span class="na">p:port=</span><span class="s">&quot;${spring.redis.port}&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>アノテーションでのキャッシュを有効にする。ローカルヒープを使用したキャッシュと同様に<code class="docutils literal"><span class="pre">order=&quot;-1&quot;</span></code>を設定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>キャッシュデータの格納場所にRedisを使用する場合は、Spring Data Redisが提供する<code class="docutils literal"><span class="pre">RedisCacheManager</span></code>をキャッシュマネージャとして使用する。
<code class="docutils literal"><span class="pre">RedisCacheManager</span></code>の設定方法は <a class="reference external" href="https://docs.spring.io/spring-data/redis/docs/2.1.4.RELEASE/reference/html/#redis:support:cache-abstraction">Support for the Spring Cache Abstraction</a> を参照されたい。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>キャッシュマネージャで利用する<code class="docutils literal"><span class="pre">redisConnectionFactory</span></code>を設定する。</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li><code class="file docutils literal"><span class="pre">application.yml</span></code></li>
</ul>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">spring</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">redis</span><span class="p p-Indicator">:</span>
    <span class="c1"># (1)</span>
    <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">6379</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><div class="first last line-block">
<div class="line"><code class="docutils literal"><span class="pre">spring.redis.host</span></code>と<code class="docutils literal"><span class="pre">spring.redis.port</span></code>に接続するredisのホストとポートを設定する。</div>
</div>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
<div class="section" id="cache-data-regist">
<span id="id7"></span><h3><a class="toc-backref" href="#id20">4.2.2.2. キャッシュするデータの選択</a><a class="headerlink" href="#cache-data-regist" title="Permalink to this headline">¶</a></h3>
<p>以下にキャッシュしたいデータを定義する方法を説明する。
Spring Cache Abstractionでは、メソッドにアノテーションを定義することでキャッシュ対象データを選択する方式をとる。
対象メソッドの戻り値がキャッシュ対象のデータとなる。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&quot;members&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberUpdateServiceImpl</span> <span class="kd">implements</span> <span class="n">MemberUpdateService</span> <span class="o">{</span>
  <span class="c1">// omitted...</span>
  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="c1">// (2)</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;&#39;member/&#39; + #customerNo&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">Member</span> <span class="nf">findMember</span><span class="o">(</span><span class="n">String</span> <span class="n">customerNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
  <span class="o">}</span>
  <span class="c1">// omitted...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">CacheConfig</span></code>アノテーションをクラスへ付与する。</p>
<p class="last">このクラス内のキャッシュアノテーションの属性cacheNamesを設定する。
ここで設定したcacheNamesはredisに格納する際のキープレフィックス（この例では「members::」）となる。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">Cacheable</span></code>アノテーションをキャッシュ対象の参照メソッドへ付与する。</p>
<p class="last">属性key(キャッシュキー)を設定する。この例では、文字列引数(customerNo)の値にプレフィックス’member/’を付けてキーにしている。例えば customerNo=000001 の場合、キャッシュキーは「members::member/000001」となり、キャッシュされる値はメソッドの戻り値となる。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Spring Cache Abstractionのアノテーションを使用する場合は、<code class="docutils literal"><span class="pre">&#64;Cacheable</span></code>、<code class="docutils literal"><span class="pre">&#64;CachePut</span></code>と<code class="docutils literal"><span class="pre">&#64;CacheEvict</span></code>アノテーションの属性 <em>value</em> (または <em>cacheNames</em> )の値は、Spring frameworkがキャッシュオペレーション作成時に必須の値となるため設定すること。</p>
<p>また、インタフェースにSpring Cache Abstractionのアノテーションを付与することは基本的に推奨していない。理由としては、インタフェースのメソッドの引数名はデフォルトでは取得できないためである。この制約に対しSpringは代替手段として、インタフェースしか実装しない場合(Proxyとなるインタフェース、例えばDynamoDBのリポジトリ等)にメソッドの<code class="docutils literal"><span class="pre">&#64;Cacheable</span></code>を付与する際は、メソッド引数のインデックスを指定することで引数へのアクセスを実現することが可能である。</p>
<p>以下に、インデックス指定の例を示す。</p>
<blockquote class="last">
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&quot;shardids&quot;</span><span class="o">)</span>
<span class="nd">@EnableScan</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccountShardKeyRepository</span>
                                        <span class="kd">extends</span>
                                        <span class="n">CrudRepository</span><span class="o">&lt;</span><span class="n">ShardingAccount</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="c1">// (1)</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;&#39;shardid/&#39; + #a0&quot;</span><span class="o">)</span>
  <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ShardingAccount</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">Cacheable</span></code>アノテーションの属性<code class="docutils literal"><span class="pre">key</span></code>で設定している、<code class="docutils literal"><span class="pre">#a0</span></code>がメソッド<code class="docutils literal"><span class="pre">findById</span></code>の引数0番目(id)を指定している。</p>
<p class="last">詳細は <a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/integration.html#cache-spel-context">Springのリファレンス Available caching SpEL evaluation context</a> を参照されたい。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div></blockquote>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id21">4.2.2.3. キャッシュしたデータの削除</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>キャッシュデータは、対象データが更新または、削除された場合にキャッシュデータの削除が必要になる。</p>
<p>以下にキャッシュしたデータを削除する定義方法を説明する。
Spring Cache Abstractionでは、メソッドにアノテーションを定義することでキャッシュ対象データを削除する方式をとる。
メソッドで定義したアノテーションキーが削除対象データのキーとなる。</p>
<blockquote>
<div><div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&quot;members&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberUpdateServiceImpl</span> <span class="kd">implements</span> <span class="n">MemberUpdateService</span> <span class="o">{</span>
  <span class="c1">// omitted...</span>
  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
  <span class="c1">// (2)</span>
  <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;&#39;member/&#39; + #customerNo&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="n">Member</span> <span class="nf">findMember</span><span class="o">(</span><span class="n">String</span> <span class="n">customerNo</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
  <span class="o">}</span>
  <span class="c1">// (3)</span>
  <span class="c1">// omitted...</span>
  <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&quot;&#39;member/&#39; + #member.customerNo&quot;</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateMember</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">CacheConfig</span></code>アノテーションをクラスへ付与する。
ここで設定したcacheNamesはredisに格納する際のキープレフィックス（この例では「members::」）となる。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><a class="reference internal" href="#cache-data-regist"><span class="std std-ref">キャッシュするデータの選択</span></a>で説明したキャッシュデータを登録または参照するメソッド定義。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">CacheEvict</span></code>アノテーションをキャッシュ対象の更新メソッドへ付与する。</p>
<p class="last">属性key(キャッシュキー)を設定する。この例では、引数であるMemberオブジェクトのフィールド(customerNo)の値にプレフィックス’member/’を付けてキーにしている。例えば customerNo=000001 の場合、キャッシュキーは「members::member/000001」となり、(2)でキャッシュされたキーを同じになるため、(2)でキャッシュされた値を削除する。</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>トランザクショナルなDBの値をキャッシュデータにしている場合は、DBの値更新時に完全なデータの同期が出来ない事に注意が必要である。</p>
<p class="last">DBの値が更新され、コミットされてからキャッシュデータが削除されるまでの間のデータ参照は古いキャッシュデータが参照される。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id22">4.2.2.4. 注意事項</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>ローカルヒープ領域を利用した場合は、キャッシュが共有される範囲は同一のDIコンテナ内のみである。</li>
<li>特にローカルヒープ領域をキャッシュ格納場所に使用する場合は、キャッシュ対象データのサイズに注意すること。ヒープサイズに見合わない量のデータをキャッシュした場合、パフォーマンスが低下したりメモリ不足に陥る可能性がある。そのような場合には、ローカルヒープ領域外を格納場所として使用するなどを検討すること。</li>
<li>本ガイドラインで説明しているセッションの外部管理の方法と、<a class="reference internal" href="#cache-redis-setting"><span class="std std-ref">Redisを使用したキャッシュの設定</span></a> にて説明した方法でRedisを使用したキャッシュを併用する場合、接続先のRedisは同一のRedisとなる。高負荷での運用が想定されるアプリケーションについては、セッション情報とキャッシュを格納するRedisを別にすることでコネクション数の枯渇を回避することが出来る。キャッシュ格納用のRedisの設定方法については、 <a class="reference internal" href="#redis-setting-for-multi-instance"><span class="std std-ref">目的別に接続先Redisを指定する</span></a> を参照。</li>
</ul>
</div>
</div>
<div class="section" id="how-to-extend">
<h2><a class="toc-backref" href="#id23">4.2.3. How to extend</a><a class="headerlink" href="#how-to-extend" title="Permalink to this headline">¶</a></h2>
<div class="section" id="redis-setting-for-multi-instance">
<span id="id10"></span><h3><a class="toc-backref" href="#id24">4.2.3.1. 目的別に接続先Redisを指定する</a><a class="headerlink" href="#redis-setting-for-multi-instance" title="Permalink to this headline">¶</a></h3>
<p>高負荷での運用が想定される場合等、セッションの外部管理やキャッシュの格納等の複数の目的でRedisを使用する際に、利用目的別に接続先のRedisを別にすることが望ましいケースがある。</p>
<p>以下に、キャッシュ格納用のRedisを目的別に設定する方法を示す。</p>
<blockquote>
<div><div class="highlight-xml"><div class="highlight"><pre><span></span>・・・
<span class="nt">&lt;cache:annotation-driven</span> <span class="na">order=</span><span class="s">&quot;-1&quot;</span> <span class="nt">/&gt;</span>
・・・
<span class="c">&lt;!-- (1) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;cacheManager&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.cache.RedisCacheManager&quot;</span>
    <span class="na">factory-method=</span><span class="s">&quot;create&quot;</span>
    <span class="na">c:connection-factory-ref=</span><span class="s">&quot;jedisConnectionFactoryForCache&quot;</span>
    <span class="na">p:transaction-aware=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- (2) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jedisConnectionFactoryForCache&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (3) --&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.connection.RedisClusterConfiguration&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                    <span class="nt">&lt;value&gt;</span>${redis.cache.cluster.node1}<span class="nt">&lt;/value&gt;</span>
                    <span class="nt">&lt;value&gt;</span>${redis.cache.cluster.node2}<span class="nt">&lt;/value&gt;</span>
                    <span class="nt">&lt;value&gt;</span>${redis.cache.cluster.node3}<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
            <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- (4) --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;redis.clients.jedis.JedisPoolConfig&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxTotal&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.cache.maxTotal}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.cache.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWaitMillis&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.cache.maxWaitMillis}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.cache.minIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="c">&lt;!-- (5) --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jedisConnectionFactoryForSession&quot;</span> <span class="na">primary=</span><span class="s">&quot;true&quot;</span>
    <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span>
            <span class="na">class=</span><span class="s">&quot;org.springframework.data.redis.connection.RedisClusterConfiguration&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                    <span class="nt">&lt;value&gt;</span>${redis.session.cluster.node1}<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
            <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;redis.clients.jedis.JedisPoolConfig&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxTotal&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.session.maxTotal}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.session.maxIdle}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;maxWaitMillis&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.session.maxWaitMillis}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;minIdle&quot;</span> <span class="na">value=</span><span class="s">&quot;${redis.session.minIdle}&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>キャッシュマネージャとして<cite>RedisCacheManager</cite>を使用する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first"><cite>JedisConnectionFactory</cite>を使用したコネクションファクトリのBean定義を行う。コンストラクタに<cite>RedisClusterConfiguration</cite>と<cite>JedisPoolConfig</cite>を指定し、接続先のRedisクラスタの指定および接続設定を行う。AutoConfigurationによる<cite>RedisConnectionFactory</cite>のBean定義との重複を避けるため、idを”jedisConnectionFactory”とは異なる文字列とする。</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><cite>JedisConnectionFactory</cite>のコンストラクタに<cite>RedisClusterConfiguration</cite>を指定する場合、接続先のRedisはクラスタ構成であることが必須となる。スタンドアローン構成のRedisに接続する場合は<cite>JedisConnectionFactory</cite>に直接接続先のServerとPortを指定すること。
指定方法については、<a class="reference external" href="https://docs.spring.io/spring-data/redis/docs/2.1.4.RELEASE/reference/html/#redis:connectors:jedis">Spring Data Redisのリファレンス</a> を参照されたい。</p>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><cite>RedisClusterConfiguration</cite>のBean定義を行う。コンストラクタの引数に接続先のノードを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><cite>JedisPoolConfig</cite>のBean定義を行う。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><cite>RedisConnectionFactory</cite>インタフェースの実装クラスをBean定義すると、AutoConfigurationによる<cite>RedisConnectionFactory</cite>のBean定義が無効となる。そのため、Spring Sessionがセッション情報をRedisに格納するために使用する<cite>JedisConnectionFactory</cite>のBean定義を行う。<cite>primary=”true”</cite>を指定し、Spring Sessionが<cite>RedisTemplate</cite>を生成する際に優先的に使用させる。</td>
</tr>
</tbody>
</table>
<p>プロパティキーに対応する値の設定を行う。</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">redis</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">cache</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">cluster</span><span class="p p-Indicator">:</span>
      <span class="c1"># (1)</span>
      <span class="l l-Scalar l-Scalar-Plain">node1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30001</span>
      <span class="l l-Scalar l-Scalar-Plain">node2</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30002</span>
      <span class="l l-Scalar l-Scalar-Plain">node3</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30003</span>
    <span class="c1"># (2)</span>
    <span class="l l-Scalar l-Scalar-Plain">maxTotal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
    <span class="l l-Scalar l-Scalar-Plain">maxIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
    <span class="l l-Scalar l-Scalar-Plain">maxWaitMillis</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-1</span>
    <span class="l l-Scalar l-Scalar-Plain">minIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">session</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">cluster</span><span class="p p-Indicator">:</span>
      <span class="c1"># (3)</span>
      <span class="l l-Scalar l-Scalar-Plain">node1</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30004</span>
      <span class="l l-Scalar l-Scalar-Plain">node2</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30005</span>
      <span class="l l-Scalar l-Scalar-Plain">node3</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:30006</span>
    <span class="c1"># (4)</span>
    <span class="l l-Scalar l-Scalar-Plain">maxTotal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
    <span class="l l-Scalar l-Scalar-Plain">maxIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
    <span class="l l-Scalar l-Scalar-Plain">maxWaitMillis</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">-1</span>
    <span class="l l-Scalar l-Scalar-Plain">minIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>キャッシュを格納するRedisの接続先ノードを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>キャッシュを格納するRedisの<cite>JedisPoolConfig</cite>に設定するプロパティを指定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>セッションを格納するRedisの接続先ノードを指定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>セッションを格納するRedisの<cite>JedisPoolConfig</cite>に設定するプロパティを指定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="muiti-cache-manager">
<span id="id11"></span><h3><a class="toc-backref" href="#id25">4.2.3.2. 複数のキャッシュマネージャを併用する</a><a class="headerlink" href="#muiti-cache-manager" title="Permalink to this headline">¶</a></h3>
<p>Spring Cache Abstractionでは、複数のキャッシュマネージャを別のBean名で定義しておき、<cite>&#64;Cacheable</cite>アノテーションの<cite>cacheManager</cite>属性に指定することで、キャッシュ対象データ毎に使用するキャッシュマネージャを指定することが可能である。
詳細は、<a class="reference external" href="https://docs.spring.io/spring/docs/5.1.4.RELEASE/spring-framework-reference/integration.html#cache-annotations-cacheable-cache-resolver">Custom cache resolution &lt;Custom cache resolution</a> を参照されたい。</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../AWSCollaboration/index.html" title="5. AWS連携"
             >next</a> |</li>
        <li class="right" >
          <a href="DataAccessMyBatis3.html" title="4.1. データベースシャーディング"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Framework オンライン版クラウド拡張 Development Guideline 1.1.1.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >4. データアクセス</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017 NTT Corporation.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>