<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4.1. データベースシャーディング &#8212; Macchinetta Framework for Java クラウド拡張 Development Guideline 1.2.0.RELEASE documentation</title>
    <link rel="stylesheet" href="../../_static/solar.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.2.0.RELEASE',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.2. キャッシュの抽象化（Cache Abstraction）" href="CacheAbstraction.html" />
    <link rel="prev" title="4. データアクセス" href="index.html" /><script src="../../_static/jquery.treeview.js" type="text/javascript"></script>
<!-- <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:300italic,400italic,700italic,400,300,700' rel='stylesheet' type='text/css'> -->
<link href="../../_static/solarized-dark.css" rel="stylesheet">
<link href="../../_static/jquery.treeview.css" rel="stylesheet">
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="CacheAbstraction.html" title="4.2. キャッシュの抽象化（Cache Abstraction）"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. データアクセス"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Framework for Java クラウド拡張 Development Guideline 1.2.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">4. データアクセス</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><label><input id="scroll" type="checkbox" checked> scroll sidebar</label>

  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4.1. データベースシャーディング</a><ul>
<li><a class="reference internal" href="#overview">4.1.1. Overview</a><ul>
<li><a class="reference internal" href="#id3">4.1.1.1. 実現方針</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use">4.1.2. How to use</a><ul>
<li><a class="reference internal" href="#create-all-shard-datasource-label">4.1.2.1. 各シャードのデータソースの生成</a><ul>
<li><a class="reference internal" href="#datasource-definition-label">4.1.2.1.1. 設定ファイルに各シャードのデータソース情報を定義</a></li>
<li><a class="reference internal" href="#datasource-mapping-label">4.1.2.1.2. 定義されたデータソース情報をオブジェクトにマッピング</a></li>
<li><a class="reference internal" href="#datasource-mapping-object-label">4.1.2.1.3. マッピングされたデータベースのプロパティクラスを元にデータソースを生成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shard-routing-data-source-label">4.1.2.2. シャーディング対応データソース（ルーティングデータソース）</a><ul>
<li><a class="reference internal" href="#data-source-key-holder-label">4.1.2.2.1. データソースキーホルダクラス</a></li>
<li><a class="reference internal" href="#routing-data-source-label">4.1.2.2.2. ルーティングデータソースクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-shard-key-label">4.1.2.3. シャードキーの取得</a><ul>
<li><a class="reference internal" href="#shardwithaccount">4.1.2.3.1. <code class="docutils literal"><span class="pre">&#64;ShardWithAccount</span></code>アノテーション</a></li>
<li><a class="reference internal" href="#shardaccountparam">4.1.2.3.2. <code class="docutils literal"><span class="pre">&#64;ShardAccountParam</span></code>アノテーション</a></li>
<li><a class="reference internal" href="#sharding-account-helper-label">4.1.2.3.3. シャードアカウントヘルパークラス</a></li>
<li><a class="reference internal" href="#sharding-interceptor-label">4.1.2.3.4. シャーディングインターセプタクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resolve-use-shard-key-labal">4.1.2.4. 使用するシャードの解決</a></li>
<li><a class="reference internal" href="#decide-shard-node-label">4.1.2.5. シャードの割り当て決定</a><ul>
<li><a class="reference internal" href="#shard-key-resolver-label">4.1.2.5.1. シャードキーリゾルバクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sharding-in-application-label">4.1.2.6. アプリケーションでのシャーディングの利用</a><ul>
<li><a class="reference internal" href="#allocation-shard-label">4.1.2.6.1. シャードの割り当て</a></li>
<li><a class="reference internal" href="#resolve-shard-label">4.1.2.6.2. シャードの解決</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">4. データアクセス</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="CacheAbstraction.html"
                        title="next chapter">4.2. キャッシュの抽象化（Cache Abstraction）</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ArchitectureInDetail/DataAccessDetail/DataAccessMyBatis3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>4.1. データベースシャーディング<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="id2">
<p class="topic-title first">目次</p>
<ul class="simple">
<li><a class="reference internal" href="#overview" id="id23">Overview</a><ul>
<li><a class="reference internal" href="#id3" id="id24">実現方針</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-use" id="id25">How to use</a><ul>
<li><a class="reference internal" href="#create-all-shard-datasource-label" id="id26">各シャードのデータソースの生成</a><ul>
<li><a class="reference internal" href="#datasource-definition-label" id="id27">設定ファイルに各シャードのデータソース情報を定義</a></li>
<li><a class="reference internal" href="#datasource-mapping-label" id="id28">定義されたデータソース情報をオブジェクトにマッピング</a></li>
<li><a class="reference internal" href="#datasource-mapping-object-label" id="id29">マッピングされたデータベースのプロパティクラスを元にデータソースを生成</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shard-routing-data-source-label" id="id30">シャーディング対応データソース（ルーティングデータソース）</a><ul>
<li><a class="reference internal" href="#data-source-key-holder-label" id="id31">データソースキーホルダクラス</a></li>
<li><a class="reference internal" href="#routing-data-source-label" id="id32">ルーティングデータソースクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-shard-key-label" id="id33">シャードキーの取得</a><ul>
<li><a class="reference internal" href="#shardwithaccount" id="id34"><code class="docutils literal"><span class="pre">&#64;ShardWithAccount</span></code>アノテーション</a></li>
<li><a class="reference internal" href="#shardaccountparam" id="id35"><code class="docutils literal"><span class="pre">&#64;ShardAccountParam</span></code>アノテーション</a></li>
<li><a class="reference internal" href="#sharding-account-helper-label" id="id36">シャードアカウントヘルパークラス</a></li>
<li><a class="reference internal" href="#sharding-interceptor-label" id="id37">シャーディングインターセプタクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resolve-use-shard-key-labal" id="id38">使用するシャードの解決</a></li>
<li><a class="reference internal" href="#decide-shard-node-label" id="id39">シャードの割り当て決定</a><ul>
<li><a class="reference internal" href="#shard-key-resolver-label" id="id40">シャードキーリゾルバクラス</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sharding-in-application-label" id="id41">アプリケーションでのシャーディングの利用</a><ul>
<li><a class="reference internal" href="#allocation-shard-label" id="id42">シャードの割り当て</a></li>
<li><a class="reference internal" href="#resolve-shard-label" id="id43">シャードの解決</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id23">4.1.1. Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../../ImplementationAtEachLayer/PersistenceLayerScalability.html"><span class="doc">データ永続層のスケール性の確保</span></a> で説明したシャーディング方式を、Springの<code class="docutils literal"><span class="pre">RoutingDataSource</span></code>やAOPの仕組みを用いて実現する方法を説明する。</p>
<p>本ガイドラインでは、以下に示すイメージの赤枠破線部分(Spring提供機能以外)について説明する。枠線外のShardKey RepositoryとStorage Device(記憶装置)については、<a class="reference internal" href="../../ImplementationAtEachLayer/PersistenceLayerScalability.html"><span class="doc">データ永続層のスケール性の確保</span></a> の <a class="reference internal" href="../../ImplementationAtEachLayer/PersistenceLayerScalability.html#shardkey-management-policy"><span class="std std-ref">シャードキーの管理方針</span></a>に基づき、Key-Value Store(KVS)を用いるのが望ましいため、クラウドプラットフォームで提供されるKVSを利用することを推奨する。クラウドプラットフォームにAWSを選択する場合のKVSについては、<a class="reference internal" href="../../AWSCollaboration/DatabaseSharding.html"><span class="doc">データベースシャーディング</span></a> を参照されたい。</p>
<p>なお、イメージの赤枠実線部分(Sharding AOP、Routing Data Source、ShardKey Repository)は横断的な機能のため、アプリケーション開発者全員が作成する必要はない。</p>
<blockquote>
<div><div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/data-access-mybatis3.png"><img alt="../../_images/data-access-mybatis3.png" src="../../_images/data-access-mybatis3.png" style="width: 90%;" /></a>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>Controllerが<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>と<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーション付のServiceメソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">Sharding AOPがShardKey Repositoryを呼び出しシャードを特定する。</p>
<p class="last"><a class="reference internal" href="#resolve-use-shard-key-labal"><span class="std std-ref">使用するシャードの解決</span></a>をするためのShardKey Repositoryの実装は、使用するStorage Deviceによって変わる。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>Sharding AOPは、(2)で特定したシャードをRouting Data Sourceへ伝播する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>Transaction AOPは、Transaction Managerを呼び出す。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>Transaction Managerは、Routing Data Sourceから(3)で伝播されたシャードの<code class="docutils literal"><span class="pre">Connection</span></code>を取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>Transaction Managerは、(5)で取得した<code class="docutils literal"><span class="pre">Connection</span></code>でトランザクションを開始しConnection Holderへ<code class="docutils literal"><span class="pre">Connection</span></code>を格納する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>Serviceは、Shard RepositoryのDBアクセスメソッドを呼び出す。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>Shard Repositoryは、Mybatis Springを経由してDBへクエリを発行する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>Mybatis Springは、(6)で格納した<code class="docutils literal"><span class="pre">Connection</span></code>をConnection Holderから取得しDBへアクセスする。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id24">4.1.1.1. 実現方針</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>RDB製品依存のシャーディングの仕組み(例：<code class="docutils literal"><span class="pre">pg_shard</span></code>等)は使用しない。</li>
<li>性能劣化やアプリケーションの複雑性の回避のため、分散トランザクションは使用しない。</li>
<li><code class="docutils literal"><span class="pre">Spring</span></code>の<code class="docutils literal"><span class="pre">RoutingDataSource</span></code>の仕組みを拡張し、シャード毎にデータソースを切り替える。</li>
<li>テスト容易性のため、シャード切り替えの制御処理をプログラマティックに記述させない(AOPで宣言的に記述)</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="how-to-use">
<h2><a class="toc-backref" href="#id25">4.1.2. How to use</a><a class="headerlink" href="#how-to-use" title="Permalink to this headline">¶</a></h2>
<p>シャーディングを行うにあたり、各シャードに対しデータソースを定義する必要がある。
本ガイドラインで紹介する方式では、Springの仕組みを用いつつ以下の実装を独自に行う必要がある。</p>
<ul>
<li><p class="first"><a class="reference internal" href="#create-all-shard-datasource-label"><span class="std std-ref">各シャードのデータソースの生成</span></a></p>
<p>設定ファイルに定義された複数の接続情報などを元に、シャードとなるデータソースを動的に生成するための実装</p>
</li>
<li><p class="first"><a class="reference internal" href="#shard-routing-data-source-label"><span class="std std-ref">シャーディング対応データソース（ルーティングデータソース）</span></a></p>
<p>シャードキーに基づいて使用するシャード（データソース）を選択するデータソース（Springの<code class="docutils literal"><span class="pre">RoutingDataSource</span></code>を拡張）</p>
</li>
<li><p class="first"><a class="reference internal" href="#get-shard-key-label"><span class="std std-ref">シャードキーの取得</span></a></p>
<p>AOPによりメソッド呼び出し情報の中からシャードキーを抽出するための実装</p>
</li>
<li><p class="first"><a class="reference internal" href="#resolve-use-shard-key-labal"><span class="std std-ref">使用するシャードの解決</span></a></p>
<p>シャードキーから、割り当てられたシャードを決定するための実装</p>
</li>
<li><p class="first"><a class="reference internal" href="#decide-shard-node-label"><span class="std std-ref">シャードの割り当て決定</span></a></p>
<p>新たな要素が追加されたときに、シャードキーからシャードを決定するための実装</p>
</li>
<li><p class="first"><a class="reference internal" href="#sharding-in-application-label"><span class="std std-ref">アプリケーションでのシャーディングの利用</span></a></p>
<p>シャードの解決と割り当てをアプリケーションで実装</p>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="create-all-shard-datasource-label">
<span id="id4"></span><h3><a class="toc-backref" href="#id26">4.1.2.1. 各シャードのデータソースの生成</a><a class="headerlink" href="#create-all-shard-datasource-label" title="Permalink to this headline">¶</a></h3>
<p>シャーディングをする場合は、非シャード とシャード毎にデータソース情報の定義が必要になる。
さらに、シャードの増減や冗長なデータソース情報の定義を避けるため、以下のことを考慮する必要がある。</p>
<ul class="simple">
<li>シャード数を増減させる際に、最小限の設定の変更だけで実現できる</li>
<li>冗長な設定を削減しつつ、シャード個別のチューニングも可能にする</li>
</ul>
<p>上記を考慮した、各シャードのデータソースを生成する手順を以下に示す。</p>
<ul class="simple">
<li><a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>する。</li>
<li><a class="reference internal" href="#datasource-mapping-label"><span class="std std-ref">定義されたデータソース情報をオブジェクトにマッピング</span></a>する。</li>
<li><a class="reference internal" href="#datasource-mapping-object-label"><span class="std std-ref">マッピングされたデータベースのプロパティクラスを元にデータソースを生成</span></a>する。</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="datasource-definition-label">
<span id="id5"></span><h4><a class="toc-backref" href="#id27">4.1.2.1.1. 設定ファイルに各シャードのデータソース情報を定義</a><a class="headerlink" href="#datasource-definition-label" title="Permalink to this headline">¶</a></h4>
<p>データソース情報の定義には、1つの共通情報と複数の個別情報があり、それぞれを定義する。</p>
<blockquote>
<div><p>以下に、<code class="docutils literal"><span class="pre">xxx-env/src/main/resources/application-local.yml</span></code>での設定を示す。</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">database</span><span class="p p-Indicator">:</span>
  <span class="c1"># (1)</span>
  <span class="l l-Scalar l-Scalar-Plain">common</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">data-source</span><span class="p p-Indicator">:</span>
      <span class="c1"># (5)</span>
      <span class="l l-Scalar l-Scalar-Plain">driverClassName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">org.postgresql.Driver</span>
      <span class="l l-Scalar l-Scalar-Plain">maxActive</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">96</span>
      <span class="l l-Scalar l-Scalar-Plain">maxIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16</span>
      <span class="l l-Scalar l-Scalar-Plain">minIdle</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
      <span class="l l-Scalar l-Scalar-Plain">maxWait</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">90000</span>
      <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
      <span class="l l-Scalar l-Scalar-Plain">username</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
  <span class="c1"># (2)</span>
  <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">schema</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
  <span class="c1"># (3)</span>
  <span class="l l-Scalar l-Scalar-Plain">data-sources</span><span class="p p-Indicator">:</span>
    <span class="c1"># (4)</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">schema</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
      <span class="c1"># (5)</span>
      <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:postgresql://localhost:5432/xxx</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">schema</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xxx1</span>
      <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:postgresql://localhost:5432/xxx1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">schema</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">xxx2</span>
      <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jdbc:postgresql://localhost:5432/xxx2</span>
      <span class="c1"># (6)</span>
      <span class="l l-Scalar l-Scalar-Plain">maxActive</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first">データソースの共通情報を設定する(任意設定)。ここで設定した値は、シャードの個別情報の設定値で上書きされる。</p>
<p class="last">全シャード共通のデータソース情報の基本となる設定値。
データソースのプロパティキーを設定する。この例では、データソースに Tomcat 9.0 JDBC Connection Pool を使用した場合の設定例を示している。
詳細は、<a class="reference external" href="https://tomcat.apache.org/tomcat-9.0-doc/jdbc-pool.html#Common_Attributes">公式サイト</a> を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>非シャード (デフォルトスキーマ)を指定するキーを設定する。(必須)</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td><p class="first">全てのシャードのデータソース個別情報を設定する。</p>
<p class="last">省略されたプロパティについては、(1)の設定値が反映される。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first">schema(データソースキー)を設定する。</p>
<p class="last">シャードのキーとなる値。 非シャード は１つ、シャードは１つ以上の設定が必須である。 非シャード の値は(2)で設定した値と同一になる。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p class="first">データソースの設定値。</p>
<p class="last">データソースのプロパティキーを設定する。この例では、データソースに Tomcat 9.0 JDBC Connection Pool を使用した場合の設定例を示している。
詳細は、<a class="reference external" href="https://tomcat.apache.org/tomcat-9.0-doc/jdbc-pool.html#Common_Attributes">公式サイト</a> を参照されたい。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p class="first">maxActiveを30に個別設定する。</p>
<p class="last">共通情報を個別情報で上書きし、設定したシャード(schema=xxx2)だけmaxActiveが30となる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="datasource-mapping-label">
<span id="id8"></span><h4><a class="toc-backref" href="#id28">4.1.2.1.2. 定義されたデータソース情報をオブジェクトにマッピング</a><a class="headerlink" href="#datasource-mapping-label" title="Permalink to this headline">¶</a></h4>
<p>データソース情報の定義には、1つの共通情報と複数の個別情報の２種類が定義されるため、それぞれをデータベースのプロパティクラスにマッピングするため、これらのプロパティクラスを実装する。また、それぞれのクラスのBean定義をする必要もある。</p>
<ul>
<li><p class="first">共通情報プロパティクラスのBean定義</p>
<p>以下に、共通情報プロパティクラス<code class="docutils literal"><span class="pre">CommonDatabaseProperties</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;commonDatabaseProperties&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.model.CommonDatabaseProperties&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">個別情報プロパティクラスのBean定義</p>
<p>以下に、個別情報プロパティクラス<code class="docutils literal"><span class="pre">DatabaseProperties</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;databaseProperties&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.model.DatabaseProperties&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">共通情報プロパティクラスの実装</p>
<p>以下に、共通情報プロパティクラス<code class="docutils literal"><span class="pre">CommonDatabaseProperties</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;database.common&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonDatabaseProperties</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// getter &amp; setter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ConfigurationProperties</span></code>アノテーションをクラスへ付与する。</p>
<p class="last">アノテーションの<code class="docutils literal"><span class="pre">prefix</span></code>属性に、<a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>のプレフィックス<code class="docutils literal"><span class="pre">database.common</span></code>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">データソース情報をマッピングする<code class="docutils literal"><span class="pre">Map</span></code>クラスを設定する。</p>
<p class="last">データソース情報をマッピングする項目は、<a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>のプロパティキー<code class="docutils literal"><span class="pre">database.common.data-source</span></code>の後のキー名と同じになる。定義されるプロパティキーの増減に対応するため<code class="docutils literal"><span class="pre">Map</span></code>クラスを使用している。</p>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">個別情報プロパティクラスの実装</p>
<p>以下に、個別情報プロパティクラス<code class="docutils literal"><span class="pre">DatabaseProperties</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;database&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatabaseProperties</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="c1">// getter &amp; setter</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ConfigurationProperties</span></code>アノテーションをクラスへ付与する。</p>
<p class="last">アノテーションの<code class="docutils literal"><span class="pre">prefix</span></code>属性に、<a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>のプレフィックス<code class="docutils literal"><span class="pre">database</span></code>を指定する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">データソース情報をマッピングするリストを設定する。</p>
<p class="last">データソース情報をマッピングする<code class="docutils literal"><span class="pre">Map</span></code>クラスのリスト。
データソース情報をマッピングする項目は、<a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>のプロパティキー<code class="docutils literal"><span class="pre">database.data-sources</span></code>の後のキー名と同じになる。定義されるプロパティキーの増減に対応するため<code class="docutils literal"><span class="pre">Map</span></code>クラスのリストを使用している。</p>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="datasource-mapping-object-label">
<span id="id9"></span><h4><a class="toc-backref" href="#id29">4.1.2.1.3. マッピングされたデータベースのプロパティクラスを元にデータソースを生成</a><a class="headerlink" href="#datasource-mapping-object-label" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="#datasource-mapping-label"><span class="std std-ref">定義されたデータソース情報をオブジェクトにマッピング</span></a>したプロパティクラスを元にデータソースを生成するため、データソースビルダクラスとデータソースファクトリクラスを実装する。また、それぞれのクラスのBean定義をする必要もある。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">データソースファクトリクラスは、使用するデータソースに合わせて実装できるよう、<code class="docutils literal"><span class="pre">DataSourceFactory</span></code>のインタフェースを用意し汎化しておく。</p>
</div>
</div></blockquote>
<ul>
<li><p class="first">データソースファクトリクラスのBean定義</p>
<p>以下に、データソースファクトリクラス<code class="docutils literal"><span class="pre">TomcatDataSourceFactory</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSourceFactory&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.pool.TomcatDataSourceFactory&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">データソースビルダクラスのBean定義</p>
<p>以下に、データソースビルダクラス<code class="docutils literal"><span class="pre">RoutingDataSourceBuilder</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;routingDataSourceBuilder&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.RoutingDataSourceBuilder&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- (1) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;databaseProperties&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">ref=</span><span class="s">&quot;commonDatabaseProperties&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSourceFactory&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>コンストラクタの引数でデータソースの個別情報プロパティクラス、共通情報プロパティクラスとデータソースファクトリクラスを設定する。</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">データソースファクトリクラスの実装</p>
<p>データソースファクトリクラスは<code class="docutils literal"><span class="pre">DataSourceFactory</span></code>のインタフェースを使用し、使用するデータソースに合わせて実装する。</p>
<p>以下に、<code class="docutils literal"><span class="pre">org.apache.tomcat.jdbc.pool.DataSource</span></code>を使用したデータソースファクトリクラスの実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TomcatDataSourceFactory</span> <span class="kd">implements</span> <span class="n">DataSourceFactory</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">tomcat</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">DataSourceFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">tomcat</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">DataSourceFactory</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">DataSource</span> <span class="nf">create</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">dataSourceProperties</span><span class="o">,</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">commonDataSourceProperties</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">DataSource</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">commonDataSourceProperties</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// (4)</span>
            <span class="n">properties</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">commonDataSourceProperties</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// (5)</span>
        <span class="n">properties</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">dataSourceProperties</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// (6)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createDataSource</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="o">(</span><span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9008</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9008</span>
                    <span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>データソースファクトリクラスは、<code class="docutils literal"><span class="pre">DataSourceFactory</span></code>インタフェースの実装クラスとして作成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>データソースを作成する<code class="docutils literal"><span class="pre">org.apache.tomcat.jdbc.pool.DataSourceFactory</span></code>のインスタンスを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>データソース作成メソッドを実装する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>データソースの共通情報が定義されていたら共通情報を設定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>データソースの個別情報で共通情報を上書きマージする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>データソースを作成する。</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul>
<li><p class="first">データソースビルダクラスの実装</p>
<p>以下に、データソースビルダクラス<code class="docutils literal"><span class="pre">RoutingDataSourceBuilder</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoutingDataSourceBuilder</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>
  <span class="c1">// (2)</span>
  <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${database.default.schema.name:default}&quot;</span><span class="o">)</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">databaseDefaultSchemaName</span><span class="o">;</span>
  <span class="c1">// (3)</span>
  <span class="kd">private</span> <span class="n">DatabaseProperties</span> <span class="n">databaseProperties</span><span class="o">;</span>
  <span class="c1">// (4)</span>
  <span class="kd">private</span> <span class="n">CommonDatabaseProperties</span> <span class="n">commonDatabaseProperties</span><span class="o">;</span>
  <span class="c1">// (5)</span>
  <span class="kd">private</span> <span class="n">DataSourceFactory</span> <span class="n">dataSourceFactory</span><span class="o">;</span>
  <span class="c1">// (6)</span>
  <span class="nd">@Inject</span>
  <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>
  <span class="c1">// (7)</span>
  <span class="nd">@Inject</span>
  <span class="n">DefaultListableBeanFactory</span> <span class="n">factory</span><span class="o">;</span>
  <span class="c1">// (8)</span>
  <span class="kd">public</span> <span class="nf">RoutingDataSourceBuilder</span><span class="o">(</span><span class="n">DatabaseProperties</span> <span class="n">databaseProperties</span><span class="o">,</span>
          <span class="n">CommonDatabaseProperties</span> <span class="n">commonDatabaseProperties</span><span class="o">,</span>
          <span class="n">DataSourceFactory</span> <span class="n">dataSourceFactory</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// omitted...</span>
      <span class="k">this</span><span class="o">.</span><span class="na">databaseProperties</span> <span class="o">=</span> <span class="n">databaseProperties</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">commonDatabaseProperties</span> <span class="o">=</span> <span class="n">commonDatabaseProperties</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">dataSourceFactory</span> <span class="o">=</span> <span class="n">dataSourceFactory</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// (9)</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dataSources</span> <span class="o">=</span> <span class="n">databaseProperties</span>
              <span class="o">.</span><span class="na">getDataSources</span><span class="o">();</span>
      <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">targetDataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
      <span class="kt">boolean</span> <span class="n">defaultTargetDataSourceFlg</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">dataSourceProperties</span> <span class="o">:</span> <span class="n">dataSources</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">String</span> <span class="n">sourceKey</span> <span class="o">=</span> <span class="n">dataSourceProperties</span>
                  <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ShardKeyResolver</span><span class="o">.</span><span class="na">SCHEMA_KEY_NAME</span><span class="o">);</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="n">javax</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">DataSource</span> <span class="n">source</span> <span class="o">=</span> <span class="n">dataSourceFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
                      <span class="n">dataSourceProperties</span><span class="o">,</span> <span class="n">commonDatabaseProperties</span>
                              <span class="o">.</span><span class="na">getDataSource</span><span class="o">());</span>
              <span class="n">factory</span><span class="o">.</span><span class="na">registerSingleton</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">,</span> <span class="n">source</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalStateException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="o">(</span><span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9007</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9007</span>
                      <span class="o">.</span><span class="na">getMessage</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">),</span> <span class="n">e</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="o">(</span><span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9008</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9008</span>
                      <span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">databaseDefaultSchemaName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">))</span> <span class="o">{</span>
              <span class="c1">// (10)</span>
              <span class="k">this</span><span class="o">.</span><span class="na">defaultTargetDataSource</span> <span class="o">=</span> <span class="n">applicationContext</span>
                      <span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">);</span>
              <span class="n">defaultTargetDataSourceFlg</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="c1">// (11)</span>
              <span class="n">targetDataSources</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">,</span> <span class="n">applicationContext</span>
                      <span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">sourceKey</span><span class="o">));</span>
          <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">defaultTargetDataSourceFlg</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="o">(</span><span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9006</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9006</span>
                  <span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">targetDataSources</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">SystemException</span><span class="o">(</span><span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9005</span><span class="o">.</span><span class="na">getCode</span><span class="o">(),</span> <span class="n">LogMessages</span><span class="o">.</span><span class="na">E_AR_A0_L9005</span>
                  <span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">this</span><span class="o">.</span><span class="na">targetDataSources</span> <span class="o">=</span> <span class="n">targetDataSources</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// (12)</span>
  <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">getTargetDataSources</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">targetDataSources</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="c1">// (13)</span>
  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getDefaultTargetDataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">defaultTargetDataSource</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>データソースビルダクラスは、<code class="docutils literal"><span class="pre">InitializingBean</span></code>の実装クラスとして作成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>で指定した、 非シャード (デフォルトスキーマ)キーをインジェクトする。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>コンストラクタで設定される、データソースの個別情報プロパティクラスを保持するフィールドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>コンストラクタで設定される、データソースの共通情報プロパティクラスを保持するフィールドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>コンストラクタで設定される、データソースファクトリクラスを保持するフィールドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">ApplicationContext</span></code>のインジェクトする。</p>
<p class="last">一度登録したデータソースを取得するために使用する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">DefaultListableBeanFactory</span></code>のインジェクトする。</p>
<p class="last">データソースを実行時に動的にインスタンス化し、SpringのDIコンテナに登録してBeanとして扱えるようにするために使用する。</p>
</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>コンストラクタの引数で(2)、(3)と(4)を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><code class="docutils literal"><span class="pre">InitializingBean</span></code>のメソッド<code class="docutils literal"><span class="pre">afterPropertiesSet()</span></code>をオーバーライドし、データソースを作成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>非シャード のデータソースを保持する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td>シャードのデータソースを保持する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td>シャードのデータソースを取得するメソッドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(13)</div>
</div>
</td>
<td>非シャード のデータソースを取得するメソッドを定義する。</td>
</tr>
</tbody>
</table>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="shard-routing-data-source-label">
<span id="id10"></span><h3><a class="toc-backref" href="#id30">4.1.2.2. シャーディング対応データソース（ルーティングデータソース）</a><a class="headerlink" href="#shard-routing-data-source-label" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#create-all-shard-datasource-label"><span class="std std-ref">各シャードのデータソースの生成</span></a>で生成されたデータソースを、シャーディング対応データソースに格納するため、<a class="reference internal" href="#routing-data-source-label"><span class="std std-ref">ルーティングデータソースクラス</span></a>と<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を実装する。データソースキーホルダクラスは、後述の<a class="reference internal" href="#decide-shard-node-label"><span class="std std-ref">シャードの割り当て決定</span></a>で決定したデータソースキーを保持・伝播する入れ物のことである。また、それぞれのクラスのBean定義をする必要もある。</p>
<div class="section" id="data-source-key-holder-label">
<span id="id11"></span><h4><a class="toc-backref" href="#id31">4.1.2.2.1. データソースキーホルダクラス</a><a class="headerlink" href="#data-source-key-holder-label" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>以下に、データソースキーホルダクラス<code class="docutils literal"><span class="pre">DataSourceLookupKeyHolder</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;dataSourceLookupKeyHolder&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.RoutingDataSourceLookupKeyHolder&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、データソースキーホルダクラス<code class="docutils literal"><span class="pre">RoutingDataSourceLookupKeyHolder</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoutingDataSourceLookupKeyHolder</span> <span class="o">{</span>
    <span class="c1">// (1)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">contextHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// (2)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">dataSourceKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">contextHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">dataSourceKey</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">contextHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// (4)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">contextHolder</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>スレッド毎にデータソースキーを保持する変数を定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>データソースキーを設定するメソッドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>データソースキーを取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>保持したデータソースキーを削除するメソッドを定義する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="routing-data-source-label">
<span id="id12"></span><h4><a class="toc-backref" href="#id32">4.1.2.2.2. ルーティングデータソースクラス</a><a class="headerlink" href="#routing-data-source-label" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p><code class="docutils literal"><span class="pre">RoutingDataSource</span></code>は、Springが提供する、複数のデータソースを定義し動的に切り替えを行う仕組みである。簡単な使用方法は <a class="reference external" href="https://macchinetta.github.io/server-guideline/1.7.0.RELEASE/ja/ArchitectureInDetail/DataAccessDetail/DataAccessCommon.html#data-access-common-todo-multiple-datasource-howtoextends">こちら</a> を参照すること。</p>
<p>以下に、ルーティングデータソースクラス<code class="docutils literal"><span class="pre">RoutingDataSource</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;routingDataSource&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.RoutingDataSource&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- (1) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;routingDataSourceBuilder&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSourceLookupKeyHolder&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>コンストラクタの引数でデータソースビルダクラスと<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を設定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、ルーティングデータソースクラス<code class="docutils literal"><span class="pre">RoutingDataSource</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoutingDataSource</span> <span class="kd">extends</span> <span class="n">AbstractRoutingDataSource</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${database.default.schema.name:default}&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">databaseDefaultSchemaName</span><span class="o">;</span>
    <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">RoutingDataSourceLookupKeyHolder</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">;</span>
    <span class="c1">// (4)</span>
    <span class="kd">public</span> <span class="nf">RoutingDataSource</span><span class="o">(</span>
            <span class="n">RoutingDataSourceBuilder</span> <span class="n">routingDataSourceBuilder</span><span class="o">,</span>
            <span class="n">RoutingDataSourceLookupKeyHolder</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setDefaultTargetDataSource</span><span class="o">(</span><span class="n">routingDataSourceBuilder</span><span class="o">.</span><span class="na">getDefaultTargetDataSource</span><span class="o">());</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">setTargetDataSources</span><span class="o">(</span><span class="n">routingDataSourceBuilder</span><span class="o">.</span><span class="na">getTargetDataSources</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSourceLookupKeyHolder</span> <span class="o">=</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// (5)</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">Object</span> <span class="nf">determineCurrentLookupKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// (6)</span>
        <span class="k">return</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>実装クラスは、<code class="docutils literal"><span class="pre">AbstractRoutingDataSource</span></code>のサブクラスとして実装する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>で指定した、デフォルトキーをインジェクトする。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>コンストラクタで設定される、<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を保持するフィールドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first">コンストラクタでデータソースビルダクラスと<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を取得する。</p>
<p class="last">データソースビルダクラスから 非シャード のデータソースとシャードのデータソースのリストを取得して親クラスのコンストラクタへ渡す。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>キー選択のメソッドをオーバーライドする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p class="first"><a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>からデータソースキーを取得する。</p>
<p class="last"><a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>から取得した値が<code class="docutils literal"><span class="pre">null</span></code>の場合は、 非シャード のデータソースが選択される。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="get-shard-key-label">
<span id="id14"></span><h3><a class="toc-backref" href="#id33">4.1.2.3. シャードキーの取得</a><a class="headerlink" href="#get-shard-key-label" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#resolve-use-shard-key-labal"><span class="std std-ref">使用するシャードの解決</span></a>をするため、後述の<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>と<a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>の情報を元にメソッド引数からシャードキーの値を取得する<a class="reference internal" href="#sharding-account-helper-label"><span class="std std-ref">シャードアカウントヘルパークラス</span></a>と、<a class="reference internal" href="#shard-routing-data-source-label"><span class="std std-ref">シャーディング対応データソース（ルーティングデータソース）</span></a>で説明した<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>にデータソースキーを設定する<a class="reference internal" href="#sharding-interceptor-label"><span class="std std-ref">シャーディングインターセプタクラス</span></a>を実装する。また、それぞれのクラスのBean定義をする必要もある。</p>
<p>また、トランザクション境界となるサービスクラスの対象メソッドにシャード対象であることを示すアノテーションを付与する必要がある。
以下で、付与する<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>と<a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>についても説明する。</p>
<div class="section" id="shardwithaccount">
<span id="shard-with-account-annotaition-label"></span><h4><a class="toc-backref" href="#id34">4.1.2.3.1. <code class="docutils literal"><span class="pre">&#64;ShardWithAccount</span></code>アノテーション</a><a class="headerlink" href="#shardwithaccount" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;ShardWithAccount</span></code>アノテーションは、トランザクションを開始するサービスメソッドに付与し属性<code class="docutils literal"><span class="pre">value</span></code>にシャードキーを保持するオブジェクトのパスを設定する。</p>
<blockquote>
<div><p>以下に、<code class="docutils literal"><span class="pre">&#64;ShardWithAccount</span></code>アノテーションの実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ShardWithAccount</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="n">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>付与する対象をメソッドに設定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">属性<code class="docutils literal"><span class="pre">value</span></code>。</p>
<p class="last">シャードキーを保持するオブジェクトのパスを設定する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>の使用例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicketReserveServiceImpl</span> <span class="kd">implements</span> <span class="n">TicketReserveService</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
    <span class="c1">// (1)</span>
    <span class="nd">@Transactional</span>
    <span class="c1">// (2)</span>
    <span class="nd">@ShardWithAccount</span><span class="o">(</span><span class="s">&quot;reservation.repMember.customerNo&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">registerMemberReservation</span><span class="o">(</span><span class="n">Reservation</span> <span class="n">reservation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted...</span>
    <span class="o">}</span>
    <span class="nd">@Transactional</span>
    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">TicketReserveDto</span> <span class="nf">registerReservation</span><span class="o">(</span><span class="n">String</span> <span class="n">reserveNo</span><span class="o">,</span> <span class="n">Reservation</span> <span class="n">reservation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted...</span>
    <span class="o">}</span>
    <span class="c1">// omitted...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>メソッドにトランザクション境界を示す<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションを付与する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">メソッドにシャード対象であることを示す<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を付与し、属性<code class="docutils literal"><span class="pre">value</span></code>にシャードキーを保持するオブジェクトのパス<code class="docutils literal"><span class="pre">reservation.repMember.customerNo</span></code>を設定する。</p>
<p class="last">シャードキーを保持するオブジェクトは、引数<code class="docutils literal"><span class="pre">reservation</span></code>のプロパティである<code class="docutils literal"><span class="pre">repMember</span></code>が保持する<code class="docutils literal"><span class="pre">java.lang.String</span></code>型のプロパティ<code class="docutils literal"><span class="pre">customerNo</span></code>となる。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>メソッドにシャード対象であることを示す<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>が付与されていないため、非シャード にアクセスする。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="shardaccountparam">
<span id="shard-account-param-annotaition-label"></span><h4><a class="toc-backref" href="#id35">4.1.2.3.2. <code class="docutils literal"><span class="pre">&#64;ShardAccountParam</span></code>アノテーション</a><a class="headerlink" href="#shardaccountparam" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">&#64;ShardAccountParam</span></code>アノテーションは、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>が付与されたメソッドの引数に付与するマーカーアノテーションである。メソッド引数が複数ある場合に、シャードキーを保持するオブジェクトを特定するために使用する。</p>
<blockquote>
<div><p>以下に、<code class="docutils literal"><span class="pre">&#64;ShardAccountParam</span></code>アノテーションの実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// (1)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ShardAccountParam</span> <span class="o">{</span>

<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>付与する対象を引数に設定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、<a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>の使用例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicketReserveServiceImpl</span> <span class="kd">implements</span> <span class="n">TicketReserveService</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
    <span class="c1">// (1)</span>
    <span class="nd">@Transactional</span>
    <span class="c1">// (2)</span>
    <span class="nd">@ShardWithAccount</span><span class="o">(</span><span class="s">&quot;reservation.repMember.customerNo&quot;</span><span class="o">)</span>
    <span class="c1">// (3)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">registerMemberReservation</span><span class="o">(</span><span class="n">String</span> <span class="n">xxxxxxx</span><span class="o">,</span> <span class="nd">@ShardAccountParam</span> <span class="n">Reservation</span> <span class="n">reservation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// omitted...</span>
    <span class="o">}</span>
    <span class="c1">// omitted...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>メソッドにトランザクション境界を示す<code class="docutils literal"><span class="pre">&#64;Transactional</span></code>アノテーションを付与する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>メソッドにシャード対象であることを示す<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を付与する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>引数<code class="docutils literal"><span class="pre">Reservation</span></code>がシャードキーを保持するオブジェクトであるため、第2引数<code class="docutils literal"><span class="pre">Reservation</span></code>に<a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>アノテーションを付与する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="sharding-account-helper-label">
<span id="id15"></span><h4><a class="toc-backref" href="#id36">4.1.2.3.3. シャードアカウントヘルパークラス</a><a class="headerlink" href="#sharding-account-helper-label" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>以下に、シャードアカウントヘルパークラス <code class="docutils literal"><span class="pre">ShardAccountHelper</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;shardAccountHelper&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.helper.ShardAccountHelper&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、シャードアカウントヘルパークラス<code class="docutils literal"><span class="pre">ShardAccountHelper</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShardAccountHelper</span> <span class="o">{</span>
    <span class="c1">// omitted...</span>
    <span class="c1">// (1)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getAccountValue</span><span class="o">(</span><span class="n">MethodInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// (2)</span>
        <span class="n">Object</span> <span class="n">target</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getThis</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// (3)</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">targetClass</span> <span class="o">=</span> <span class="n">AopUtils</span><span class="o">.</span><span class="na">getTargetClass</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
        <span class="c1">// (4)</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">arguments</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getArguments</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">classes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">arguments</span> <span class="o">&amp;&amp;</span> <span class="n">arguments</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getParameterTypes</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// (5)</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">ReflectionUtils</span><span class="o">.</span><span class="na">findMethod</span><span class="o">(</span><span class="n">targetClass</span><span class="o">,</span> <span class="n">invocation</span>
                <span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">classes</span><span class="o">);</span>
        <span class="c1">// (6)</span>
        <span class="n">ShardWithAccount</span> <span class="n">shardWithAccount</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span>
                <span class="n">method</span><span class="o">,</span> <span class="n">ShardWithAccount</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">shardWithAccount</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (7)</span>
            <span class="n">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">shardWithAccount</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">values</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;[.]&quot;</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">argumentsLength</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">arguments</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">ShardAccountParam</span> <span class="n">shardAccountParam</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">Parameter</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Parameter</span> <span class="n">parameter</span> <span class="o">:</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// // (8)</span>
                    <span class="n">shardAccountParam</span> <span class="o">=</span> <span class="n">AnnotationUtils</span><span class="o">.</span><span class="na">findAnnotation</span><span class="o">(</span>
                            <span class="n">parameter</span><span class="o">,</span> <span class="n">ShardAccountParam</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">shardAccountParam</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// (9)</span>
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">[</span><span class="n">argumentsLength</span><span class="o">];</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">argumentsLength</span><span class="o">++;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">shardAccountParam</span> <span class="o">&amp;&amp;</span> <span class="n">values</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// omitted...</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// omitted...</span>
            <span class="o">}</span>
            <span class="c1">// (10)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">ExpressionParser</span> <span class="n">expressionParser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpelExpressionParser</span><span class="o">();</span>
                <span class="n">Expression</span> <span class="n">expression</span> <span class="o">=</span> <span class="n">expressionParser</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="n">exp</span><span class="o">);</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">obj</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>シャードキーを取得するメソッドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>実行対象のオブジェクトを取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>実行対象のクラスを取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>実行対象メソッドの引数を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>実行対象のメソッドを取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>実行対象のメソッドに付与された<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>の属性valueの値を取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td>メソッド引数が複数の場合に<a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td><a class="reference internal" href="#shard-account-param-annotaition-label"><span class="std std-ref">&#64;ShardAccountParamアノテーション</span></a>が付与されている引数のオブジェクトを取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>対象オブジェクトからシャードキーの値を取得する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="sharding-interceptor-label">
<span id="id16"></span><h4><a class="toc-backref" href="#id37">4.1.2.3.4. シャーディングインターセプタクラス</a><a class="headerlink" href="#sharding-interceptor-label" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>以下に、シャーディングインターセプタクラス <code class="docutils literal"><span class="pre">AccountShardInterceptor</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;accountShardInterceptor&quot;</span>
  <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.interceptor.AccountShardInterceptor&quot;</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- (1) --&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;accountShardKeyRepository&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">ref=</span><span class="s">&quot;shardAccountHelper&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span> <span class="na">ref=</span><span class="s">&quot;dataSourceLookupKeyHolder&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;aop:config&gt;</span>
  <span class="c">&lt;!-- omitted... --&gt;</span>
  <span class="c">&lt;!-- (2) --&gt;</span>
  <span class="nt">&lt;aop:advisor</span> <span class="na">order=</span><span class="s">&quot;-1&quot;</span> <span class="na">advice-ref=</span><span class="s">&quot;accountShardInterceptor&quot;</span>
    <span class="na">pointcut=</span><span class="s">&quot;@annotation(com.example.xxx.domain.common.shard.annotation.ShardWithAccount)&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/aop:config&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>コンストラクタの引数でシャードキーリポジトリクラス、<a class="reference internal" href="#sharding-account-helper-label"><span class="std std-ref">シャードアカウントヘルパークラス</span></a>と<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を設定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><p class="first">AOPの設定をする。</p>
<p class="last">ここでは、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>が付与されたメソッド呼び出し時にシャーディングインターセプタクラスが動作する設定にしている。また、トランザクション開始前にシャードキーを取得するため、<code class="docutils literal"><span class="pre">order=&quot;-1&quot;</span></code>を設定しトランザクションインターセプタより先に動作する設定とする。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、シャーディングインターセプタクラス<code class="docutils literal"><span class="pre">AccountShardInterceptor</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountShardInterceptor</span> <span class="kd">implements</span> <span class="n">MethodInterceptor</span><span class="o">,</span> <span class="n">InitializingBean</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="kd">private</span> <span class="n">AccountShardKeyRepository</span> <span class="n">accountShardKeyRepository</span><span class="o">;</span>
    <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">ShardAccountHelper</span> <span class="n">shardAccountHelper</span><span class="o">;</span>
    <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">RoutingDataSourceLookupKeyHolder</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">;</span>
    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="nf">AccountShardInterceptor</span><span class="o">(</span>
            <span class="n">AccountShardKeyRepository</span> <span class="n">accountShardKeyRepository</span><span class="o">,</span>
            <span class="n">ShardAccountHelper</span> <span class="n">shardAccountHelper</span><span class="o">,</span>
            <span class="n">RoutingDataSourceLookupKeyHolder</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">accountShardKeyRepository</span> <span class="o">=</span> <span class="n">accountShardKeyRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">shardAccountHelper</span> <span class="o">=</span> <span class="n">shardAccountHelper</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSourceLookupKeyHolder</span> <span class="o">=</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// omitted...</span>
    <span class="c1">// (6)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">MethodInvocation</span> <span class="n">invocation</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="c1">// (7)</span>
        <span class="n">String</span> <span class="n">beforeKey</span> <span class="o">=</span> <span class="n">dataSourceLookupKeyHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">dataSourceKey</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// (8)</span>
        <span class="n">String</span> <span class="n">account</span> <span class="o">=</span> <span class="n">shardAccountHelper</span><span class="o">.</span><span class="na">getAccountValue</span><span class="o">(</span><span class="n">invocation</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">account</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// (9)</span>
            <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ShardingAccount</span><span class="o">&gt;</span> <span class="n">shardingAccount</span> <span class="o">=</span> <span class="n">accountShardKeyRepository</span>
                    <span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">acccount</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">shardingAccount</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// (10)</span>
                <span class="n">dataSourceKey</span> <span class="o">=</span> <span class="n">shardingAccount</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getDataSourceKey</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// (11)</span>
        <span class="n">dataSourceLookupKeyHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">dataSourceKey</span><span class="o">);</span>

        <span class="n">Object</span> <span class="n">ret</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">invocation</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// (12)</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">beforeKey</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">dataSourceLookupKeyHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">beforeKey</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">dataSourceLookupKeyHolder</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>シャーディングインターセプタクラスは、<code class="docutils literal"><span class="pre">MethodInterceptor</span></code>と<code class="docutils literal"><span class="pre">InitializingBean</span></code>の実装クラスとして作成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>コンストラクタで設定される、シャードキーリポジトリクラスを保持するフィールドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>コンストラクタで設定される、<a class="reference internal" href="#sharding-account-helper-label"><span class="std std-ref">シャードアカウントヘルパークラス</span></a>を保持するフィールドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>コンストラクタで設定される、<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を保持するフィールドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>コンストラクタ引数でシャードキーリポジトリクラス、<a class="reference internal" href="#sharding-account-helper-label"><span class="std std-ref">シャードアカウントヘルパークラス</span></a>と<a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>を取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>シャードキーを設定する実行メソッドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td>シャードのネスト処理に対応するため、一つ前のシャードキーを保持する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(8)</div>
</div>
</td>
<td><a class="reference internal" href="#sharding-account-helper-label"><span class="std std-ref">シャードアカウントヘルパークラス</span></a>からシャードキーを取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(9)</div>
</div>
</td>
<td>シャードキーリポジトリクラスがKVSに問い合わせ結果を取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(10)</div>
</div>
</td>
<td>(9)の結果からデータソースキーを取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(11)</div>
</div>
</td>
<td><a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>に(7)で取得したデータソースキーを設定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(12)</div>
</div>
</td>
<td><a class="reference internal" href="#data-source-key-holder-label"><span class="std std-ref">データソースキーホルダクラス</span></a>の状態を戻す。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="resolve-use-shard-key-labal">
<span id="id17"></span><h3><a class="toc-backref" href="#id38">4.1.2.4. 使用するシャードの解決</a><a class="headerlink" href="#resolve-use-shard-key-labal" title="Permalink to this headline">¶</a></h3>
<p>データソースキーは、前出で説明した通りクラウドプラットフォームで提供されるKVSを利用することを前提とする。KVSに永続化したシャードキー情報とデータソースキーのマッピングを取得するため、シャードキーリポジトリクラスの実装とBean定義が必要となる。</p>
<p>シャードキーリポジトリクラスの実装は、使用するKVSに合わせて実装する。AWSの場合は、KVSに<a class="reference internal" href="../../AWSCollaboration/DatabaseSharding.html#aws-dynamodb"><span class="std std-ref">DynamoDB</span></a>を使用する。</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="decide-shard-node-label">
<span id="id18"></span><h3><a class="toc-backref" href="#id39">4.1.2.5. シャードの割り当て決定</a><a class="headerlink" href="#decide-shard-node-label" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#resolve-use-shard-key-labal"><span class="std std-ref">使用するシャードの解決</span></a>により、シャードキーに対応するシャードを解決するためには、事前にシャードキーとシャードのマッピング情報を<a class="reference internal" href="../../ImplementationAtEachLayer/PersistenceLayerScalability.html#shardkey-management-policy"><span class="std std-ref">シャードキーの管理方針</span></a>に従って管理されている必要がある。シャーディング対象のデータの要素が新たに作成された際に、その要素のシャードキーをインプットとし、何かしらのルールに従って割り当てるシャードを決定し、そのマッピング情報を保存する。ここでは、シャードキーを元にラウンドロビンでシャードを割り当てる例を紹介する。
なお、<strong>この割り当ては新たな要素が作成されたタイミングのみ実行すること</strong>。一度シャードの割り当てが実行された以降は、<a class="reference internal" href="#resolve-use-shard-key-labal"><span class="std std-ref">使用するシャードの解決</span></a>により割り当てられたシャードを解決する。</p>
<p>シャードの割り当てを決定するため、シャードキーの値を元にデータソースキーを決定するシャードキーリゾルバクラスを実装する。また、このクラスのBean定義をする必要もある。</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">シャードキーリゾルバクラスは、シャードの割り当てロジックを変更できるよう、<code class="docutils literal"><span class="pre">ShardKeyResolver</span></code>のインタフェースを用意し汎化しておく。また、シャードの割り当てを決定する時は、シャードキーをラウンドロビンのようにアクセス数が均等になるようにシャードをマッピングする。</p>
</div>
</div></blockquote>
<div class="section" id="shard-key-resolver-label">
<span id="id19"></span><h4><a class="toc-backref" href="#id40">4.1.2.5.1. シャードキーリゾルバクラス</a><a class="headerlink" href="#shard-key-resolver-label" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>以下に、シャードキーリゾルバクラス <code class="docutils literal"><span class="pre">DataSourceKeyResolver</span></code>のBean定義例を示す。</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;shardKeyResolver&quot;</span>
    <span class="na">class=</span><span class="s">&quot;com.example.xxx.domain.common.shard.datasource.DataSourceKeyResolver&quot;</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- (1) --&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">&quot;0&quot;</span> <span class="na">ref=</span><span class="s">&quot;databaseProperties&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>コンストラクタの引数でデータソースの個別情報プロパティクラスを設定する。</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
<blockquote>
<div><p>以下に、シャードキーリゾルバクラス <code class="docutils literal"><span class="pre">DataSourceKeyResolver</span></code>の実装例を示す。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="c1">// omitted...</span>
<span class="c1">// (1)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataSourceKeyResolver</span> <span class="kd">implements</span> <span class="n">ShardKeyResolver</span><span class="o">,</span> <span class="n">InitializingBean</span> <span class="o">{</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${database.default.schema.name:default}&quot;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">databaseDefaultSchemaName</span><span class="o">;</span>
    <span class="c1">// (3)</span>
    <span class="kd">private</span> <span class="n">DatabaseProperties</span> <span class="n">databaseProperties</span><span class="o">;</span>
    <span class="c1">// (4)</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">dataSources</span><span class="o">;</span>
    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="nf">DataSourceKeyResolver</span><span class="o">(</span><span class="n">DatabaseProperties</span> <span class="n">databaseProperties</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">databaseProperties</span> <span class="o">=</span> <span class="n">databaseProperties</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// (6)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">dataSource</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">databaseProperties</span>
                <span class="o">.</span><span class="na">getDataSources</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">databaseDefaultSchemaName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dataSource</span>
                    <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ShardKeyResolver</span><span class="o">.</span><span class="na">SCHEMA_KEY_NAME</span><span class="o">)))</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">dataSources</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// (7)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">resolveShardKey</span><span class="o">(</span><span class="n">String</span> <span class="n">shardKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">shardKey</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">dataSourceIndex</span> <span class="o">=</span> <span class="n">key</span> <span class="o">%</span> <span class="o">(</span><span class="n">dataSources</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">dataSources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dataSourceIndex</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ShardKeyResolver</span><span class="o">.</span><span class="na">SCHEMA_KEY_NAME</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>シャードキーリゾルバクラスは、<code class="docutils literal"><span class="pre">ShardKeyResolver</span></code>と<code class="docutils literal"><span class="pre">InitializingBean</span></code>インタフェースの実装クラスとして作成する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td><a class="reference internal" href="#datasource-definition-label"><span class="std std-ref">設定ファイルに各シャードのデータソース情報を定義</span></a>で指定した、デフォルトキーをインジェクトする。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>コンストラクタで設定される、データソースの個別情報プロパティクラスを保持するフィールドを定義する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>シャード用データソースキーのリストを保持するフィールドを定義する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td>コンストラクタの引数でデータソースの個別情報プロパティクラスを取得する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td><p class="first"><code class="docutils literal"><span class="pre">InitializingBean</span></code>のメソッド<code class="docutils literal"><span class="pre">afterPropertiesSet()</span></code>をオーバーライドし、シャード用データソースキーのリストを作成する。</p>
<p class="last">データソースの個別情報プロパティクラスからシャードのデータソースキーのリストを作成する。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(7)</div>
</div>
</td>
<td><p class="first">引数のシャードキーを元にシャードの割り当てをするメソッドを定義する。</p>
<p class="last">引数のシャードキー(例では数値)をシャード用データソースキーのリストサイズで除算した余りをインデックスとして、シャード用データソースキーのリストからデータソースキーを取得し返却する。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="sharding-in-application-label">
<span id="id20"></span><h3><a class="toc-backref" href="#id41">4.1.2.6. アプリケーションでのシャーディングの利用</a><a class="headerlink" href="#sharding-in-application-label" title="Permalink to this headline">¶</a></h3>
<p>アプリケーションでシャーディングを利用する方法について、チケット予約を例に以下の通り説明する。</p>
<ul class="simple">
<li><a class="reference internal" href="#allocation-shard-label"><span class="std std-ref">シャードの割り当て</span></a>をする。</li>
<li><a class="reference internal" href="#resolve-shard-label"><span class="std std-ref">シャードの解決</span></a>をする</li>
</ul>
<p>前提条件として、会員のチケット予約情報のDBはシャード対象としてKVSにマッピング情報が登録されている。また、フライトの空席情報のDBはシャード対象外( 非シャード )とする。</p>
<div class="section" id="allocation-shard-label">
<span id="id21"></span><h4><a class="toc-backref" href="#id42">4.1.2.6.1. シャードの割り当て</a><a class="headerlink" href="#allocation-shard-label" title="Permalink to this headline">¶</a></h4>
<p>シャードを割り当てるには、シャードキーを決定してシャードとマッピングする必要がある。</p>
<blockquote>
<div><p>以下で、新規会員登録を例に、会員情報登録サービスクラス<code class="docutils literal"><span class="pre">MemberRegisterServiceImpl</span></code>の実装を元に説明する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MemberRegisterServiceImpl</span> <span class="kd">implements</span> <span class="n">MemberRegisterService</span> <span class="o">{</span>
  <span class="c1">// omitted...</span>
  <span class="c1">// (1)</span>
  <span class="nd">@Inject</span>
  <span class="kd">private</span> <span class="n">ShardKeyResolver</span> <span class="n">shardKeyResolver</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="nd">@Transactional</span>
  <span class="kd">public</span> <span class="n">Member</span> <span class="nf">register</span><span class="o">(</span><span class="n">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// omitted...</span>
      <span class="c1">// (2)</span>
      <span class="kt">int</span> <span class="n">insertMemberCount</span> <span class="o">=</span> <span class="n">memberRepository</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
      <span class="c1">// omitted...</span>
      <span class="c1">// (3)</span>
      <span class="n">ShardingAccount</span> <span class="n">shardingAccount</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ShardingAccount</span><span class="o">();</span>
      <span class="c1">// (4)</span>
      <span class="n">shardingAccount</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getCustomerNo</span><span class="o">());</span>
      <span class="c1">// (5)</span>
      <span class="n">shardingAccount</span><span class="o">.</span><span class="na">setDataSourceKey</span><span class="o">(</span><span class="n">shardKeyResolver</span><span class="o">.</span><span class="na">resolveShardKey</span><span class="o">(</span><span class="n">member</span><span class="o">.</span><span class="na">getCustomerNo</span><span class="o">()));</span>
      <span class="c1">// (6)</span>
      <span class="n">accountShardKeyRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">shardingAccount</span><span class="o">);</span>
      <span class="c1">// omitted...</span>
      <span class="k">return</span> <span class="n">member</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td><a class="reference internal" href="#shard-key-resolver-label"><span class="std std-ref">シャードキーリゾルバクラス</span></a>をインジェクトする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>会員情報を登録し、お客様番号を取得する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>シャードのマッピング情報のオブジェクトをインスタンス化する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td>マッピング情報のシャードキーに(2)で取得したお客様番号を設定する。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><a class="reference internal" href="#shard-key-resolver-label"><span class="std std-ref">シャードキーリゾルバクラス</span></a>へ(2)で取得したお客様番号を渡してデータソースキーを取得しシャードに設定する。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(6)</div>
</div>
</td>
<td>シャードのマッピング情報をKVSに登録する。</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>シャード対象となるデータを新規で登録する場合は、シャードを特定するシャードキーを作成してデータベースへデータを登録し、KVSへシャードのマッピング情報を登録する処理が必要になる。これらの処理のトランザクション境界が別々の場合に、最後の登録処理で例外が発生すると、最初に登録したデータを削除する処理が必要となる事に注意する。</p>
<p>処理順序や例外発生のタイミングによってKVSだけにデータが登録されることが予想されるため、シャードキーとシャードのマッピング情報を保持するKVSは、不要データの削除を定期的に行うことを推奨する。</p>
<p class="last">上記の例では、DBのトランザクション境界内で最初にデータベースへ登録し、最後にKVSへ登録を行っている。これは、KVSの登録で例外発生した場合に、最初に登録したデータベースの削除処理を回避するためである。</p>
</div>
</div></blockquote>
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="resolve-shard-label">
<span id="id22"></span><h4><a class="toc-backref" href="#id43">4.1.2.6.2. シャードの解決</a><a class="headerlink" href="#resolve-shard-label" title="Permalink to this headline">¶</a></h4>
<p>シャードを解決するには、トランザクション境界となるサービスクラスの対象メソッドにシャード対象であることを示す<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を付与する。</p>
<p>なお、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>が付与されていない場合は、非シャード にアクセスする。</p>
<blockquote>
<div><p>以下で、チケット予約を例に、チケット予約サービスクラス<code class="docutils literal"><span class="pre">TicketReserveServiceImpl</span></code>の実装を元に説明する。</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicketReserveServiceImpl</span> <span class="kd">implements</span> <span class="n">TicketReserveService</span> <span class="o">{</span>
    <span class="c1">// (1)</span>
    <span class="nd">@Inject</span>
    <span class="n">TicketSharedService</span> <span class="n">ticketSharedService</span><span class="o">;</span>
    <span class="c1">// (2)</span>
    <span class="nd">@Inject</span>
    <span class="n">FlightRepository</span> <span class="n">flightRepository</span><span class="o">;</span>
    <span class="c1">// (3)</span>
    <span class="nd">@Inject</span>
    <span class="n">ReservationRepository</span> <span class="n">reservationRepository</span><span class="o">;</span>
    <span class="c1">// omitted...</span>
    <span class="nd">@Transactional</span>
    <span class="c1">// (4)</span>
    <span class="nd">@ShardWithAccount</span><span class="o">(</span><span class="s">&quot;reservation.repMember.customerNo&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">registerMemberReservation</span><span class="o">(</span><span class="n">Reservation</span> <span class="n">reservation</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="nd">@Transactional</span>
    <span class="c1">// (5)</span>
    <span class="kd">public</span> <span class="n">TicketReserveDto</span> <span class="nf">registerReservation</span><span class="o">(</span><span class="n">String</span> <span class="n">reserveNo</span><span class="o">,</span> <span class="n">Reservation</span> <span class="n">reservation</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    <span class="c1">// omitted...</span>
<span class="o">}</span>
</pre></div>
</div>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="10%" />
<col width="90%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">項番</th>
<th class="head">説明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(1)</div>
</div>
</td>
<td>チケット共通サービスをインジェクトする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(2)</div>
</div>
</td>
<td>フライト情報リポジトリをインジェクトする。</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(3)</div>
</div>
</td>
<td>チケット予約情報リポジトリをインジェクトする。</td>
</tr>
<tr class="row-odd"><td><div class="first last line-block">
<div class="line">(4)</div>
</div>
</td>
<td><p class="first">メソッド<code class="docutils literal"><span class="pre">registerMemberReservation</span></code>はシャード対象のため、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を付与する。</p>
<p class="last">会員のチケット予約情報を登録するメソッドのため、シャード対象となる。</p>
</td>
</tr>
<tr class="row-even"><td><div class="first last line-block">
<div class="line">(5)</div>
</div>
</td>
<td><p class="first">メソッド<code class="docutils literal"><span class="pre">registerReservation</span></code>はシャード対象外のため、<a class="reference internal" href="#shard-with-account-annotaition-label"><span class="std std-ref">&#64;ShardWithAccountアノテーション</span></a>を付与しない。</p>
<p class="last">フライトの空席数を更新するメソッドのため、シャード対象外となる。</p>
</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="CacheAbstraction.html" title="4.2. キャッシュの抽象化（Cache Abstraction）"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="4. データアクセス"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Macchinetta Framework for Java クラウド拡張 Development Guideline 1.2.0.RELEASE documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >4. データアクセス</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2017 NTT Corporation.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.6.3.Theme by <a href="http://github.com/vkvn">vkvn</a>
    </div>
    
    <script>
    
    $(function() {
    	var $sidebar	= $('.sphinxsidebar'),
    		$window		= $(window),
    		offset		= $sidebar.offset(),
    		topPadding	= 3,
    		$scroll		= $('#scroll');
    	
    	$window.scroll(function() {
    		if ($scroll.is(':checked')) {
				if ($window.scrollTop() > offset.top) {
					$sidebar.stop().animate({
						marginTop:$window.scrollTop() - offset.top + topPadding
					});
				} else {
					$sidebar.stop().animate({
						marginTop:0
					});
				}
			}
		});
    	
    	var $navList = $('ul:first', $sidebar);
    	$('li:first', $navList).addClass('open');
    	
    	$navList.treeview({
    		persist: "location",
    		collapsed: true,
    		unique: false
    	});
    	
	});
    </script>
  </body>
</html>